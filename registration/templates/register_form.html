{% extends 'abstract/main.html' %}
{% load form_tags %}

{% block content %}
<div class="container my-5">
    <form method="post" enctype="multipart/form-data" class="p-4 border rounded shadow-sm bg-light">
        {% csrf_token %}
        
        <h2 class="text-center mb-4">Register for the Event</h2>

        <!-- Email -->
        <div class="mb-3">
            <label for="{{ form.email.id_for_label }}" class="form-label">Email Address</label>
            {{ form.email|add_class:"form-control" }}
        </div>


        <!-- Category -->
        <div class="mb-3">
            <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
            {{ form.category|add_class:"form-select" }}
        </div>


        <!-- GAND Number -->
        <div class="mb-3 gand-number-field">
            <label for="{{ form.gand_number.id_for_label }}" class="form-label">GAND Number</label>
            {{ form.gand_number|add_class:"form-control" }}
        </div>

        <!-- Title -->
        <div class="mb-3">
            <label for="{{ form.title.id_for_label }}" class="form-label">Title</label>
            {{ form.title|add_class:"form-select" }}
        </div>

        <!-- Name (Auto-filled) -->
        <div class="mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">Full Name</label>
            {{ form.name|add_class:"form-control" }}
        </div>

        <!-- Phone -->
        <div class="mb-3">
            <label for="{{ form.phone.id_for_label }}" class="form-label">Phone Number</label>
            {{ form.phone|add_class:"form-control" }}
        </div>

        <!-- Address -->
        <div class="mb-3">
            <label for="{{ form.address.id_for_label }}" class="form-label">Address</label>
            {{ form.address|add_class:"form-control" }}
        </div>

        <!-- Gender -->
        <div class="mb-3">
            <label for="{{ form.gender.id_for_label }}" class="form-label">Gender</label>
            {{ form.gender|add_class:"form-select" }}
        </div>

        <!-- Profession -->
        <div class="mb-3">
            <label for="{{ form.profession.id_for_label }}" class="form-label">Profession</label>
            {{ form.profession|add_class:"form-select" }}
        </div>

        <!-- Organization -->
        <div class="mb-3">
            <label for="{{ form.organization.id_for_label }}" class="form-label">Organization</label>
            {{ form.organization|add_class:"form-control" }}
        </div>

        <!-- About Us -->
        <div class="mb-3">
            <label for="{{ form.about_us.id_for_label }}" class="form-label">How Did You Hear About Us?</label>
            {{ form.about_us|add_class:"form-select" }}
        </div>

        <!-- Compliance -->
        <div class="mb-3 form-check">
            {{ form.complaince|add_class:"form-check-input" }}
            <label class="form-check-label" for="id_complaince">I comply with the terms and conditions</label>
        </div>

        <!-- Proof of Status -->
        <div class="mb-3">
            <label for="{{ form.prof_of_status.id_for_label }}" class="form-label">Proof of Status</label>
            {{ form.prof_of_status|add_class:"form-control" }}
        </div>

        <!-- Price Display -->
        <div id="price-display" class="text-success font-weight-bold mb-3">Price: </div>
        
        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary btn-block">Proceed to Payment</button>
    </form>
</div>

<!-- Pass category_prices as JSON object to JavaScript -->
{{ category_prices|json_script:"category_prices" }}

<script>
    document.addEventListener('DOMContentLoaded', function () {
    const gandInput = document.getElementById("id_gand_number");
    const nameInput = document.getElementById("id_name");
    const categorySelect = document.getElementById("id_category");
    const priceDisplay = document.getElementById("price-display");
    const gandField = document.querySelector(".gand-number-field"); // Wrapper div for GAND Number field

    const categoryPrices = JSON.parse(document.getElementById('category_prices').textContent);

    function toggleGANDField() {
        const category = categorySelect.value;
        if (category === "GAND Student" || category === "GAND Full Member") {
            gandField.style.display = "block"; // Show GAND field
        } else {
            gandField.style.display = "none"; // Hide GAND field
            gandInput.value = ""; // Clear GAND number if not applicable
            nameInput.value = ""; // Clear name if GAND is hidden
            priceDisplay.textContent = "Price: GHS0"; // Reset price
        }
    }

    function updatePriceDisplay() {
        const category = categorySelect.value;

        if (category === "GAND Student" || category === "GAND Full Member") {
            const gandNumber = gandInput.value;
            if (gandNumber) {
                fetch(`/registration/fetch-member-info/?gand_number=${gandNumber}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            nameInput.value = data.name;
                            const standing = data.standing;
                            if (categoryPrices[standing]) {
                                priceDisplay.textContent = `Price: GHS${categoryPrices[standing][category]}`;
                            }
                        } else {
                            nameInput.value = "";
                            priceDisplay.textContent = "Price: GHS0";
                            alert(data.message || "Invalid GAND Number");
                        }
                    });
            } else {
                priceDisplay.textContent = "Price: GHS0";
            }
        } else {
            const fixedPrice = categoryPrices["fixed_pricing"]?.[category] || 0;
            priceDisplay.textContent = `Price: GHS${fixedPrice}`;
        }
    }

    // Event Listeners
    categorySelect.addEventListener("change", function () {
        toggleGANDField(); // Show/Hide GAND field based on category
        updatePriceDisplay(); // Update price when category changes
    });

    gandInput.addEventListener("blur", updatePriceDisplay); // Update price when GAND number changes

    // Initialize on page load
    toggleGANDField();
    updatePriceDisplay();
});

</script>

{% endblock %}
